---
import { getCollection, getEntry } from 'astro:content';
import Author from '@/components/ui/Author.astro';
import Container from '@/components/Container.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { DEFAULT_CONFIGURATION } from '@/lib/constants';
import PostPreview from '@/components/ui/PostPreview.astro';
import { formatDate } from '@/lib/utils';
import { render } from 'astro:content';

const entry = await getEntry('pages', 'writing');
const posts = await getCollection('posts');
const sortedPosts = posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const POSTS_PER_PAGE = 6;
const initialPosts = sortedPosts.slice(0, POSTS_PER_PAGE);
const remainingPosts = sortedPosts.slice(POSTS_PER_PAGE);

// Prepare remaining posts data for client-side rendering
const remainingPostsData = await Promise.all(
  remainingPosts.map(async (post) => {
    const { remarkPluginFrontmatter } = await render(post);
    return {
      id: post.id,
      title: post.data.title,
      date: formatDate(post.data.date),
      minutesRead: remarkPluginFrontmatter.minutesRead,
      url: `/writing/${post.id}/`,
    };
  })
);
---

<BaseLayout seo={entry.data.seo}>
  <Container as='section' class='py-6'>
    <Author {...DEFAULT_CONFIGURATION.author} />
  </Container>
  <Container as='section' class='py-6'>
    <div class="flex flex-col gap-6">
      <span class="text-headings">Latest posts</span>
      <ul class="flex flex-col gap-3" id="posts-list">
        {initialPosts.map((post) => <PostPreview entry={post} />)}
      </ul>
      {remainingPostsData.length > 0 && (
        <button
          id="load-more"
          class="self-center text-muted-foreground hover:text-headings transition-colors text-sm font-medium"
        >
          See Older Posts
        </button>
      )}
    </div>
  </Container>
</BaseLayout>

<script define:vars={{ remainingPosts: remainingPostsData }}>
  const loadMoreBtn = document.getElementById('load-more');
  const postsList = document.getElementById('posts-list');
  let loadedCount = 0;
  const BATCH_SIZE = 10;

  if (loadMoreBtn && postsList) {
    loadMoreBtn.addEventListener('click', () => {
      const toLoad = Math.min(BATCH_SIZE, remainingPosts.length - loadedCount);

      for (let i = 0; i < toLoad; i++) {
        const post = remainingPosts[loadedCount + i];
        const li = document.createElement('li');
        li.className = 'fade-in';
        li.innerHTML = `
          <div class="py-2">
            <div class="flex gap-5">
              <div class="relative min-w-22 shrink-0">
                <span class="text-muted-foreground text-sm">${post.date}</span>
              </div>
              <a href="${post.url}" class="flex flex-col gap-3">
                <div class="flex flex-col">
                  <span class="text-headings font-medium">${post.title}</span>
                  <span class="text-muted-foreground">${post.minutesRead}</span>
                </div>
              </a>
            </div>
          </div>
        `;
        postsList.appendChild(li);
      }

      loadedCount += toLoad;

      if (loadedCount >= remainingPosts.length) {
        loadMoreBtn.remove();
      }
    });
  }
</script>

<style>
  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
